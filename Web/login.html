<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Space Cowboys — Login</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="assets/images/logo.png">
  <!-- Auth0 SPA SDK (CDN) -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/1.26.0/auth0-spa-js.production.js"></script>
</head>
<body>
    <nav class="main-nav">
        <div class="nav-content">
            <div class="nav-left">
                <a href="index.html" class="nav-logo">
                    <img src="assets/images/logo.png" alt="Space Cowboys Logo">
                    <span>Space Cowboys</span>
                </a>
                <div class="nav-tabs">
                    <a href="index.html" class="nav-tab">Home</a>
                    <a href="download.html" class="nav-tab">Download</a>
                    <a href="wiki.html" class="nav-tab">Wiki</a>
                </div>
            </div>
      <div class="nav-right">
        <!-- This anchor will be switched to a Profile button when a user is logged in -->
        <a id="navAccount" href="login.html" class="nav-tab active">Login</a>
      </div>
        </div>
    </nav>

    <main class="container">

    <div id="content">
      <p id="status">Not authenticated</p>
      <div id="error" class="error-message" style="display:none"></div>

      <!-- Local credential fields (UI only). Password is hidden by default. -->
      <form id="localLoginForm" class="form" onsubmit="event.preventDefault(); handleLocalLogin();">
        <label class="field">
          <span>Username</span>
          <input id="username" type="text" name="username" placeholder="your-username" autocomplete="username">
        </label>

        <label class="field">
          <span>Password</span>
          <input id="password" type="password" name="password" placeholder="your-password" autocomplete="current-password">
        </label>

        <label class="checkbox"><input id="showPassword" type="checkbox"> Show password</label>

        <div style="margin-top:10px">
          <button id="localLogin" type="submit">Use Credentials (demo)</button>
        </div>
      </form>

      <div style="margin-top:8px; font-size:0.95rem">
        <a href="#" id="showRegisterLink">Don't have an account? Create one</a>
      </div>

      <!-- Registration form (local/demo only) -->
      <form id="registerForm" class="form" style="display:none; margin-top:12px" onsubmit="event.preventDefault(); handleRegister();">
        <label class="field">
          <span>Choose a username</span>
          <input id="registerUsername" type="text" name="registerUsername" placeholder="new-username" autocomplete="username">
        </label>

        <label class="field">
          <span>Password</span>
          <input id="registerPassword" type="password" name="registerPassword" placeholder="your-password" autocomplete="new-password">
        </label>

        <label class="field">
          <span>Confirm password</span>
          <input id="registerConfirm" type="password" name="registerConfirm" placeholder="confirm-password" autocomplete="new-password">
        </label>

        <div style="margin-top:10px">
          <button id="createAccount" type="submit">Create Account</button>
        </div>
      </form>

      <div id="buttons">
        <button id="login">Log In with Auth0</button>
        <button id="logout" style="display:none">Log Out</button>
      </div>

      <section id="profile" style="display:none">
        <h2>Profile</h2>
        <pre id="profileData"></pre>
        <p style="font-size:0.9rem;color:rgba(230,238,248,0.7)">Note: For safety the password is never displayed in the profile.</p>
      </section>

      <div class="back-link">
        <a href="index.html">← Back to Home</a>
      </div>
    </div>

    <footer>
      <small>Replace AUTH0_DOMAIN and AUTH0_CLIENT_ID in the script below with your Auth0 application values.</small>
    </footer>
  </main>

  <script>
    // TODO: Replace these with your Auth0 application's settings
    const AUTH0_DOMAIN = "YOUR_AUTH0_DOMAIN"; // e.g. dev-abc123.us.auth0.com
    const AUTH0_CLIENT_ID = "YOUR_AUTH0_CLIENT_ID"; // e.g. abcDEF1234567890

    // Redirect URI must be allowed in your Auth0 application settings.
    const REDIRECT_URI = window.location.origin + "/login.html";

    let auth0Client = null;

    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000); // Hide after 5 seconds
    }

    async function initAuth0() {
      if (AUTH0_DOMAIN.includes("YOUR_AUTH0")) {
        console.warn("Please replace AUTH0_DOMAIN and AUTH0_CLIENT_ID in login.html with your Auth0 application settings.");
      }

      try {
        auth0Client = await createAuth0Client({
          domain: AUTH0_DOMAIN,
          client_id: AUTH0_CLIENT_ID,
          cacheLocation: 'localstorage',
          useRefreshTokens: true,
          authorizationParams: {
            redirect_uri: REDIRECT_URI
          }
        });

        // handle redirect callback (if any)
        if (window.location.search.includes("code=") && window.location.search.includes("state=")) {
          try {
            const result = await auth0Client.handleRedirectCallback();
            console.log('Redirect callback handled', result);
            // remove query params from URL
            window.history.replaceState({}, document.title, REDIRECT_URI);
          } catch (err) {
            console.error('Error handling redirect callback:', err);
            showError('Login failed: ' + (err.error_description || err.message || 'Unknown error'));
          }
        }

        updateUI();
      } catch (err) {
        console.error('Auth0 initialization error:', err);
        showError('Failed to initialize login: ' + (err.error_description || err.message || 'Unknown error'));
      }
    }

    async function updateUI() {
      const isAuthenticated = await auth0Client.isAuthenticated();
      const status = document.getElementById('status');
      const loginBtn = document.getElementById('login');
      const logoutBtn = document.getElementById('logout');
      const profileSection = document.getElementById('profile');
      const profileData = document.getElementById('profileData');

      if (isAuthenticated) {
        status.textContent = 'Authenticated';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        profileSection.style.display = 'block';

          try {
            const user = await auth0Client.getUser();
            profileData.textContent = JSON.stringify(user, null, 2);
            // Persist a light-weight flag and a profile blob so other pages can show a Profile button and details
            try {
              const id = user.email || user.name || user.sub || 'auth0-user';
              localStorage.setItem('currentUser', id);
              localStorage.setItem('currentUserProfile', JSON.stringify(user));
            } catch (e) { /* ignore storage errors */ }
            refreshNavAccount();
        } catch (err) {
          showError('Failed to get user profile: ' + (err.error_description || err.message || 'Unknown error'));
        }
      } else {
        status.textContent = 'Not authenticated';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        profileSection.style.display = 'none';
        profileData.textContent = '';
        // Do not automatically remove localStorage here; logout flow will clear it.
        refreshNavAccount();
      }
    }

    document.getElementById('login').addEventListener('click', async () => {
      try {
        // Use redirect-based login (simple for static sites)
        await auth0Client.loginWithRedirect({
          authorizationParams: {
            redirect_uri: REDIRECT_URI
          }
        });
      } catch (err) {
        showError('Login failed: ' + (err.error_description || err.message || 'Unknown error'));
      }
    });

    document.getElementById('logout').addEventListener('click', async () => {
      try {
        await auth0Client.logout({
          logoutParams: { returnTo: window.location.origin }
        });
        // Remove our local marker as well
        try { localStorage.removeItem('currentUser'); } catch (e) {}
        refreshNavAccount();
        updateUI();
      } catch (err) {
        showError('Logout failed: ' + (err.error_description || err.message || 'Unknown error'));
      }
    });

    // Show/hide password toggle
    const showPasswordCheckbox = document.getElementById('showPassword');
    const passwordInput = document.getElementById('password');
    if (showPasswordCheckbox && passwordInput) {
      showPasswordCheckbox.addEventListener('change', (e) => {
        passwordInput.type = e.target.checked ? 'text' : 'password';
      });
    }

    // Handle the local/demo credential form — this is UI-only and does NOT authenticate with Auth0.
    function handleLocalLogin() {
      const username = document.getElementById('username')?.value || '';
      if (!username) {
        showError('Please enter a username');
        return;
      }
      // intentionally do not show the password in the profile for safety
      const profileData = { demoUsername: username };
      document.getElementById('profileData').textContent = JSON.stringify(profileData, null, 2);
      document.getElementById('profile').style.display = 'block';
      document.getElementById('status').textContent = 'Demo credentials shown (not authenticated)';
      // Mark the user as logged-in for UI purposes (local/demo only)
      try {
        localStorage.setItem('currentUser', username);
        localStorage.setItem('currentUserProfile', JSON.stringify({ demoUsername: username }));
      } catch (e) { /* ignore */ }
      refreshNavAccount();
    }

    // Simple client-side registration for demo/local usage.
    // Stores credentials in localStorage under key 'users' (demo only — not secure).
    function handleRegister() {
      const username = document.getElementById('registerUsername')?.value || '';
      const password = document.getElementById('registerPassword')?.value || '';
      const confirm = document.getElementById('registerConfirm')?.value || '';
      if (!username) { showError('Please enter a username'); return; }
      if (!password) { showError('Please enter a password'); return; }
      if (password !== confirm) { showError('Passwords do not match'); return; }

      // load existing users
      let users = {};
      try { users = JSON.parse(localStorage.getItem('users') || '{}'); } catch (e) { users = {}; }
      if (users[username]) { showError('That username is already taken'); return; }
      // NOTE: In a real app never store plain passwords. This is demo-only.
      users[username] = { password: password };
      try { localStorage.setItem('users', JSON.stringify(users)); } catch (e) { showError('Failed to save account'); return; }

      // Automatically sign-in the created user for UI purposes
  try { localStorage.setItem('currentUser', username); localStorage.setItem('currentUserProfile', JSON.stringify({ demoUsername: username })); } catch (e) {}
  document.getElementById('profileData').textContent = JSON.stringify({ demoUsername: username }, null, 2);
      document.getElementById('profile').style.display = 'block';
      document.getElementById('status').textContent = 'Account created — demo signed in';
  document.getElementById('registerForm').style.display = 'none';
      refreshNavAccount();
    }

    // Update the nav account anchor based on whether localStorage.currentUser is set
    function refreshNavAccount() {
      const a = document.getElementById('navAccount');
      if (!a) return;
      let user = null;
      try { user = localStorage.getItem('currentUser'); } catch (e) { user = null; }
      if (user) {
        a.textContent = 'Profile';
        a.href = 'profile.html';
        a.classList.remove('nav-tab');
        a.classList.add('nav-tab');
      } else {
        a.textContent = 'Login';
        a.href = 'login.html';
      }
    }

    // Toggle register form link
    document.getElementById('showRegisterLink').addEventListener('click', (e) => {
      e.preventDefault();
      const f = document.getElementById('registerForm');
      if (!f) return;
      f.style.display = (f.style.display === 'none' || f.style.display === '') ? 'flex' : 'none';
      refreshNavAccount();
    });

    // init
    window.addEventListener('load', () => {
      initAuth0().catch(err => {
        console.error('Auth0 init error', err);
        showError('Failed to initialize login system');
      });
    });
  </script>
</body>
</html>